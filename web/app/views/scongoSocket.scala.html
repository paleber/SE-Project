@()(implicit request: RequestHeader)
<link rel="import" href="@routes.Application.scongoFinish">
<link rel='import' href='@routes.Assets.at("bower_components/polymer/polymer.html")'>
<link rel='import' href='@routes.Assets.at("bower_components/paper-button/paper-button.html")'>

<dom-module id='scongo-socket'>

    <template>

    </template>

    <script>
            Polymer({
                is: "scongo-socket",

                properties: {
                    socket: WebSocket,
                    menuId: String,
                    menu: Object,
                    gameId: String,
                    game: Object,
                    finishId: String,
                    finish: Object,
                },

                ready: function () {
                    this.socket = new WebSocket("@routes.Application.socket.webSocketURL");

                    this.menu = document.querySelector('#' + this.menuId);
                    this.game = document.querySelector('#' + this.gameId);
                    this.finish = document.querySelector('#' + this.finishId);

                    this.socket.onopen = () => {
                        console.log("socket opened");
                        this.socket.send("menu");
                    };

                    this.socket.onerror = msg => {
                        console.log("socket error: " + msg);
                    };

                    this.socket.onmessage = msg => {
                        console.log("message received: " + JSON.parse(msg.data).jsonClass);
                        this.handleMsg(msg);
                    };

                    this.socket.onclose = () => {
                        console.log("socket closed")
                    };
                },

                sendMsg: function (msg) {
                    this.socket.send(msg);
                },

                handleMsg: function (msg) {
                    const data = JSON.parse(msg.data);

                    switch (data.jsonClass) {
                        case 'ServerMsg$ShowMenu$':
                            this.game.hide();
                            this.menu.show();
                            break;
                        case 'ServerMsg$ShowGame':
                            this.menu.hide();
                            this.game.show(data);
                            break;
                        case 'ServerMsg$UpdateBlock':
                            this.game.updateBlock(data);
                            break;
                        case 'ServerMsg$LevelFinished':
                            this.finish.show(data);
                            break;
                        default:
                            alert("Unhandled message: " + msg.data)
                    }
                }
            })
    </script>

</dom-module>
